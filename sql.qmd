---
title: "SQL"
description: |
  Using SQL to analyze police traffic stops
  
author: Devi Canseco
date: April 15, 2025
format: html
---

```{r, include = FALSE}
library(DBI)
library(RMariaDB)
library(ggplot2)

con_traffic <- DBI::dbConnect(
  RMariaDB::MariaDB(),
  dbname = "traffic",
  host = Sys.getenv("TRAFFIC_HOST"),
  user = Sys.getenv("TRAFFIC_USER"),
  password = Sys.getenv("TRAFFIC_PWD")
)

```

The data for this analysis comes from the Stanford Open Policing Project, published in Pierson et al. (2020). Which can be found in <https://openpolicing.stanford.edu/data/>. In this project, I want to compare reasonable driving stops for drivers across states. First, I will compare drivers from California and Florida with the tentative question: Which state has better drivers? To answer this question, I will find and compare the proportion of stops that resulted in a citation for each state. On a second analysis, I will utilize Philadelphia's data frame to find that searches provided resulted in a reasonable cause when performed. This follows the question: Did they have the right suspicion? I will extract the number of searches that found contraband and compare it to the total number of searches conducted.

**Better Drivers**

In this analysis, the statewide reports of LA and FL are used to form a comparison of the proportion of drivers issued a citation.

```{sql}
#| connection: con_traffic
#| output.var: "prop_table"

SELECT
    state,
    COUNT(*) AS total_stops,
    SUM(citations) AS citations,
    ROUND(SUM(citations) / COUNT(*) * 100, 2) AS citation_rate_percent
FROM (
    SELECT
        'CA' AS state,
        CASE WHEN s.citation_issued = TRUE THEN 1 ELSE 0 END AS citations
    FROM ca_statewide_2023_01_26 s
    WHERE s.citation_issued IS NOT NULL

    UNION ALL

    SELECT
        'FL' AS state,
        CASE WHEN s.citation_issued = TRUE THEN 1 ELSE 0 END AS citations
    FROM fl_statewide_2020_04_01 s
    WHERE s.citation_issued IS NOT NULL
) combined
GROUP BY state
ORDER BY citation_rate_percent DESC;
```

```{r}
ggplot(prop_table, aes(x = state, y = citations)) +
  geom_bar(stat = "identity") +
  labs(
    title = "Proportion of Drivers Issued Citations by State Patrol",
    x = "State",
    y = "Citation Rate"
  ) 
```

**Evidence Found**

In this analysis the data is taken from the Philadelphia, PA table. It seeks to find if searches resulted in finding evidence for a suspected holding of contraband.

```{sql}
#| connection: con_traffic
#| output.var: "contr_table"
SELECT
    COUNT(*) AS total_searches,
    SUM(CASE WHEN s.contraband_found = TRUE THEN 1 ELSE 0 END) AS searches_with_contraband,
    ROUND(SUM(CASE WHEN s.contraband_found = TRUE THEN 1 ELSE 0 END) / COUNT(*) * 100, 2) AS contraband_hit_rate_percent
FROM
    pa_philadelphia_2020_04_01 s
WHERE
    s.search_conducted = TRUE
    AND s.contraband_found IS NOT NULL;
```

```{r}
contr_table
```

```{r}
ggplot(contr_table, aes(y = total_searches, fill = searches_with_contraband)) +
  geom_bar() +
  labs(
    title = "Searches vs. Contraband Found — Philadelphia, PA",
    x = "",
    y = "Number of Stops"
  )
```

```{r}
DBI::dbDisconnect(con_traffic)
```

Data Source: Stanford Open Policing Project. Pierson, E., Corbett-Davies, S., & Goel, S. (2020). “A large-scale analysis of racial disparities in police stops across the United States.” *Nature Human Behaviour*, 4(7), 736–745. <https://openpolicing.stanford.edu/>
